<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.7.1 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Octree and voxelization - Mark Kim</title>




<meta name="description" content="First, I need to know how deep the octree needs to be. So, I threw the mesh into a GPU octree and it never returned. Okay, so I threw it in a CPU octree, and it never returned. Hmmm… turns out there are duplicate faces and vertices. Fixed those, nowboth the GPU and the CPU version of the octree return…a depth of 17. That meansI’m looking at a resolution of 2^17 or 131072^3. Yikes. After looking at some ofthe octree and voxelization results though, I think we can do something like 2048^3.">




<meta name="author" content="Mark Kim">

<meta property="og:locale" content="en">
<meta property="og:site_name" content="Mark Kim">
<meta property="og:title" content="Octree and voxelization">


  <link rel="canonical" href="http://localhost:4000/research/octree-voxelization/">
  <meta property="og:url" content="http://localhost:4000/research/octree-voxelization/">



  <meta property="og:description" content="First, I need to know how deep the octree needs to be. So, I threw the mesh into a GPU octree and it never returned. Okay, so I threw it in a CPU octree, and it never returned. Hmmm… turns out there are duplicate faces and vertices. Fixed those, nowboth the GPU and the CPU version of the octree return…a depth of 17. That meansI’m looking at a resolution of 2^17 or 131072^3. Yikes. After looking at some ofthe octree and voxelization results though, I think we can do something like 2048^3.">

















  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2015-03-23T17:00:00-04:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Mark Kim",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>







<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Mark Kim Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--post">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">Mark Kim</a>
        <ul class="visible-links">
          
        </ul>
        <button type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    <h3 class="author__name" itemprop="name">Mark Kim</h3>
    
      <p class="author__bio" itemprop="description">
        Postdoctoral Researcher
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      <!--
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Somewhere</span>
        </li>
      -->
      <li>
        <a href="/publications" itemprop="sameAs">
          Publications
                </a>
      </li>
      <li>
        <a href="/assets/cv.pdf" itemprop="sameAs">
          CV
                </a>
      </li>

      
      <li>
        <a href="https://www.ornl.gov/division/csmd/scientific-data" itemprop="sameAs">
          Scientific Data Group
                </a>
      </li>
    
  
      
      <li>
        <a href="https://www.ornl.gov/division/CSM" itemprop="sameAs">
          Computer Science and Mathematics
        </a>
      </li>
    


  
  <li>
    <a href="https://www.ornl.gov" itemprop="sameAs">
      Oak Ridge National Laboratory
            </a>
  </li>
  

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://bitbucket.org/m-kim" itemprop="sameAs">
            <i class="fa fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket
          </a>
        </li>
      

      
        <li>
          <a href="https://github.com/m-kim" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      
        <li>
          <a href="https://gitlab.com/m-kim" itemprop="sameAs">
            <i class="fa fa-fw fa-gitlab" aria-hidden="true"></i> GitLab
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      


      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Octree and voxelization">
    <meta itemprop="description" content="First, I need to know how deep the octree needs to be. So, I threw the mesh into a GPU octree and it never returned. Okay, so I threw it in a CPU octree, and it never returned. Hmmm… turns out there are duplicate faces and vertices. Fixed those, nowboth the GPU and the CPU version of the octree return…a depth of 17. That meansI’m looking at a resolution of 2^17 or 131072^3. Yikes. After looking at some ofthe octree and voxelization results though, I think we can do something like 2048^3.">
    <meta itemprop="datePublished" content="March 23, 2015">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Octree and voxelization
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>First, I need to know how deep the octree needs to be. So, I threw the mesh into 
a GPU octree and it never returned. Okay, so I threw it in a CPU octree, and it never returned. 
Hmmm… turns out there are duplicate faces and vertices. Fixed those, now
both the GPU and the CPU version of the octree return…a depth of 17. That means
I’m looking at a resolution of 2^17 or 131072^3. Yikes. After looking at some of
the octree and voxelization results though, I think we can do something like 2048^3.</p>

<p><img src="/assets/2015/03/23/octree-level-10.png" alt="" />
<img src="/assets/2015/03/23/octree-level-11.png" alt="" /></p>

<p>The top image is for an octree at the lowest level, where the level is 10 (2^10 = 1024)</p>

<p>The bottom image is for an octree at the lowest level, where the level is 11 (2^11 = 2048).</p>

<p>It’s easy to see that there isn’t a consistent coverage at this level.</p>

<p><img src="/assets/2015/03/23/octree-stop-at-leaf-level-10.png" alt="" />
<img src="/assets/2015/03/23/octree-stop-at-leaf-level-10-2.png" alt="" /></p>

<p>The top image is if we stop where a bounding box is a leaf. The bottom image 
is zoomed in closer. You can see there are varying levels of the 
mesh, but the vary levels have little do with the curvature and in one case, the density, of the mesh.</p>

<p>These random varying octree cells are no good. I rely on the cells to create good
embeddings. I’d rather have a consistent coverage. So, let’s try voxelization.</p>

<p>I started with this paper:</p>

<p><a href="http://dl.acm.org/citation.cfm?id=2492048">Out-of-core construction of sparse voxel octrees</a></p>

<p>and this code:</p>

<p><a href="https://github.com/Forceflow/ooc_svo_builder">Out-of-Core SVO</a></p>

<p>I first parallelized it on the CPU then did it in CUDA.</p>

<p><img src="/assets/2015/03/23/voxelization-level-10.png" alt="" />
<img src="/assets/2015/03/23/voxelization-level-6.png" alt="" /></p>

<p>The top image is voxelization with the level=10. However, it’s difficult to
discern anything, so the bottom image is level=6. The coverage is consistent, 
and near the level I want.</p>

<p>The problem is the octree on the GPU is fast and only relies on the vertices.<br />
The voxelization needs to check the faces and determine whether the 
voxel cell intersects it, so is slower. How much slower? Just the algorithm, on the GPU, 
takes approximately 0.388 seconds when the level is 2048. In total, it takes 0.74 seconds.
 Why is this so slow on the GPU?</p>

<p><img src="/assets/2015/03/23/profiler.png" alt="" /></p>

<p>This is a profile of the voxelization in CUDA on a Acer V15 Nitro Black Edition (i7-4720HQ with an Nvidia GTX-860m with 4GB VRAM). 
It is dominated by cudaReset and cudaMemcpy, where cudaReset is a kernel simply sets an array to 0 (this is faster than cudaMemset). 64% of the time
is spent running cudaReset. Previously, cudaMemset took 77% of the time.</p>

<p><img src="/assets/2015/03/23/profiler-2.png" alt="" /></p>

<p>Breaking the processing down, the image above is zoomed.</p>

<p><img src="/assets/2015/03/23/profiler-3.png" alt="" /></p>

<p>Here, the computation blocks are circled. As you can see, 4 of the five that
are highlighted are slivers.</p>

<p><img src="/assets/2015/03/23/profiler-4.png" alt="" /></p>

<p>Here, the copying and setting the memory to zero is highlighted. The time to copy back data as well as reset arrays dominates the computation.</p>

<p>The 2048^3 block is broken down into 8 regions and each region is processed separately. 
This unfortunately leaves the workload unbalanced, which we can see because only one of the eight blocks 
is visible in the graph (the other 7 are either completely absent or take so little time that they
are slivers in the graph).</p>

<p>The unbalanced workload is the achille’s heel of this. But, the only way to get 2048^3 
is to break up the grid. The copying and resetting kill performance.</p>

<p>The CUDA version is only a tenth of a second faster than a multi-core, SSE 4.2 
version I also wrote.</p>

<p>Moving foward, if I stay with the voxelization at 2048^3, I think it would be better to stick with the CPU version,
and have the time=t+1 voxelizer run as the CUDA advection at time=t is run.</p>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#research" class="page__taxonomy-item" rel="tag">research</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2015-03-23T17:00:00-04:00">March 23, 2015</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Octree+and+voxelization%20http%3A%2F%2Flocalhost%3A4000%2Fresearch%2Foctree-voxelization%2F" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fresearch%2Foctree-voxelization%2F" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fresearch%2Foctree-voxelization%2F" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fresearch%2Foctree-voxelization%2F" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/research/edelta/" class="pagination--pager" title="closest point embedding problems 5
">Previous</a>
    
    
      <a href="http://localhost:4000/research/psaap-poster/" class="pagination--pager" title="PSAAP Poster
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/research/grad-school-travel-assistance/" rel="permalink">Graduate School Travel Assistance
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Presenting our work, “Surface Flow Visualization Using the Closest Point Embedding” at a premier conference such as the IEEE Pacific Visualization Conference...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/psaap-poster/" rel="permalink">PSAAP Poster redux
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">PSAAP Poster
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/research/psaap-poster/" rel="permalink">PSAAP Poster
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">PSAAP Poster
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/research/edelta/" rel="permalink">closest point embedding problems 5
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Edit: found these in “Surface Techniques for Vortex Visualization”, Garth et al. 2004.



</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="https://github.com/m-kim"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
      <li><a href="https://gitlab.com/m-kim"><i class="fa fa-fw fa-gitlab" aria-hidden="true"></i> Gitlab</a></li>
    
    
      <li><a href="https://bitbucket.org/m-kim"><i class="fa fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 Mark Kim. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>








  </body>
</html>